<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Channel Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-danger {
            background: #dc3545;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Message Channel Error Fix Test</h1>
        
        <div class="test-section">
            <h3>üìã Test Status</h3>
            <button class="btn" onclick="testMessageChannelFix()">Test Message Channel Fix</button>
            <button class="btn btn-success" onclick="simulateMessageChannelError()">Simulate Error</button>
            <button class="btn btn-danger" onclick="clearLog()">Clear Log</button>
            <div id="test-status"></div>
        </div>

        <div class="test-section">
            <h3>üìä Fix Status</h3>
            <div id="fix-status"></div>
        </div>

        <div class="test-section">
            <h3>üìù Test Log</h3>
            <div id="test-log" class="log"></div>
        </div>
    </div>

    <script src="message-channel-fix.js"></script>
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'error' ? 'status-error' : type === 'warning' ? 'status-warning' : 'status-success';
            
            logDiv.innerHTML += `<div class="status ${statusClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function testMessageChannelFix() {
            const statusDiv = document.getElementById('test-status');
            statusDiv.innerHTML = '<div class="status status-warning">Testing message channel fix...</div>';
            
            try {
                // Check if the fix is loaded
                if (window.messageChannelFix && typeof window.messageChannelFix.initialize === 'function') {
                    log('‚úÖ Message channel fix is available');
                    
                    // Test the fix
                    window.messageChannelFix.initialize();
                    log('‚úÖ Message channel fix initialized');
                    
                    // Check if async operation manager is set up
                    if (window.asyncOperationManager) {
                        log('‚úÖ Async operation manager is available');
                    } else {
                        log('‚ùå Async operation manager not found', 'error');
                    }
                    
                    statusDiv.innerHTML = '<div class="status status-success">‚úÖ Message channel fix test passed!</div>';
                    log('‚úÖ Message channel fix test completed successfully');
                    
                } else {
                    log('‚ùå Message channel fix not available', 'error');
                    statusDiv.innerHTML = '<div class="status status-error">‚ùå Message channel fix not available</div>';
                }
                
            } catch (error) {
                log(`‚ùå Error testing message channel fix: ${error.message}`, 'error');
                statusDiv.innerHTML = `<div class="status status-error">‚ùå Test failed: ${error.message}</div>`;
            }
        }

        function simulateMessageChannelError() {
            log('‚ö†Ô∏è Simulating message channel error...', 'warning');
            
            try {
                // Try to create a scenario that might trigger the error
                const testPromise = new Promise((resolve, reject) => {
                    setTimeout(() => {
                        // Simulate an error that might occur
                        const error = new Error('A listener indicated an asynchronous response by returning true, but the message channel closed before a response was received');
                        reject(error);
                    }, 100);
                });

                testPromise.catch(error => {
                    log('‚úÖ Simulated error was caught and handled properly', 'success');
                });

                // Also test the error event handler
                const testError = new Error('A listener indicated an asynchronous response by returning true, but the message channel closed before a response was received');
                window.dispatchEvent(new ErrorEvent('error', { error: testError }));
                
                log('‚úÖ Error simulation completed');
                
            } catch (error) {
                log(`‚ùå Error during simulation: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
            log('Log cleared');
        }

        function updateFixStatus() {
            const statusDiv = document.getElementById('fix-status');
            
            let status = '<h4>Fix Components Status:</h4>';
            
            // Check error handler
            const hasErrorHandler = window.onerror !== null;
            status += `<div>${hasErrorHandler ? '‚úÖ' : '‚ùå'} Global error handler: ${hasErrorHandler ? 'Active' : 'Not set'}</div>`;
            
            // Check unhandled rejection handler
            const hasUnhandledRejectionHandler = window.onunhandledrejection !== null;
            status += `<div>${hasUnhandledRejectionHandler ? '‚úÖ' : '‚ùå'} Promise rejection handler: ${hasUnhandledRejectionHandler ? 'Active' : 'Not set'}</div>`;
            
            // Check async operation manager
            const hasAsyncManager = !!window.asyncOperationManager;
            status += `<div>${hasAsyncManager ? '‚úÖ' : '‚ùå'} Async operation manager: ${hasAsyncManager ? 'Active' : 'Not set'}</div>`;
            
            // Check message channel fix
            const hasMessageChannelFix = !!window.messageChannelFix;
            status += `<div>${hasMessageChannelFix ? '‚úÖ' : '‚ùå'} Message channel fix: ${hasMessageChannelFix ? 'Available' : 'Not available'}</div>`;
            
            statusDiv.innerHTML = status;
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            log('üöÄ Test page loaded');
            updateFixStatus();
            
            // Auto-test after a short delay
            setTimeout(() => {
                testMessageChannelFix();
                updateFixStatus();
            }, 1000);
        });

        // Update status periodically
        setInterval(updateFixStatus, 5000);
    </script>
</body>
</html>
