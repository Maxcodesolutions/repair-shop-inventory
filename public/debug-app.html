<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repair Shop Inventory - Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        .data-display {
            background: white;
            padding: 10px;
            border-radius: 3px;
            border: 1px solid #ccc;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        .error-fix-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .error-fix-section h3 {
            color: #856404;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Repair Shop Inventory - Debug Console</h1>
        
        <!-- Error Fix Section -->
        <div class="error-fix-section">
            <h3>üö® Message Channel Error Fix</h3>
            <p><strong>Error:</strong> "A listener indicated an asynchronous response by returning true, but the message channel closed before a response was received"</p>
            <p><strong>Cause:</strong> This error typically occurs when asynchronous operations are not properly managed or when there are issues with message passing between different parts of the application.</p>
            <button class="btn btn-success" onclick="fixMessageChannelError()">üîß Apply Fix</button>
            <button class="btn" onclick="checkErrorStatus()">üìä Check Error Status</button>
            <div id="error-fix-status" class="data-display"></div>
        </div>
        
        <div class="debug-section">
            <h3>üìä Data Status</h3>
            <button class="btn" onclick="checkDataStatus()">Check Data Status</button>
            <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
            <button class="btn btn-success" onclick="loadDefaultData()">Load Default Data</button>
            <div id="data-status" class="data-display"></div>
        </div>

        <div class="debug-section">
            <h3>üîê Authentication Status</h3>
            <button class="btn" onclick="checkAuthStatus()">Check Auth Status</button>
            <button class="btn" onclick="testLogin()">Test Login (admin/admin)</button>
            <button class="btn" onclick="logout()">Logout</button>
            <div id="auth-status" class="data-display"></div>
        </div>

        <div class="debug-section">
            <h3>‚òÅÔ∏è Cloud Sync Status</h3>
            <button class="btn" onclick="checkCloudSync()">Check Cloud Sync</button>
            <button class="btn" onclick="forceSyncToCloud()">Force Sync to Cloud</button>
            <button class="btn" onclick="testCloudConnection()">Test Cloud Connection</button>
            <div id="cloud-status" class="data-display"></div>
        </div>

        <div class="debug-section">
            <h3>üìù Customer Data</h3>
            <button class="btn" onclick="showCustomers()">Show Customers</button>
            <button class="btn" onclick="addTestCustomer()">Add Test Customer</button>
            <button class="btn" onclick="clearCustomers()">Clear Customers</button>
            <div id="customers-display" class="data-display"></div>
        </div>

        <div class="debug-section">
            <h3>üõ†Ô∏è Application Functions</h3>
            <button class="btn" onclick="showAvailableFunctions()">Show Available Functions</button>
            <button class="btn" onclick="testNavigation()">Test Navigation</button>
            <button class="btn" onclick="checkAppState()">Check App State</button>
            <div id="functions-display" class="data-display"></div>
        </div>

        <div class="debug-section">
            <h3>üö® Error Log</h3>
            <button class="btn" onclick="clearErrorLog()">Clear Log</button>
            <button class="btn btn-success" onclick="applyMessageChannelFix()">Apply Message Channel Fix</button>
            <div id="error-log" class="data-display"></div>
        </div>
    </div>

    <script src="firebase-global.js"></script>
    <script src="script.js"></script>
    <script src="message-channel-fix.js"></script>
    <script>
        // Global error handler to catch message channel errors
        window.addEventListener('error', function(event) {
            if (event.error && event.error.message && event.error.message.includes('message channel closed')) {
                log('Message channel error detected and handled', 'warning');
                event.preventDefault();
                return false;
            }
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message && event.reason.message.includes('message channel closed')) {
                log('Unhandled message channel rejection caught and handled', 'warning');
                event.preventDefault();
                return false;
            }
        });

        // Message channel error fix function
        function fixMessageChannelError() {
            const statusDiv = document.getElementById('error-fix-status');
            statusDiv.innerHTML = 'Applying message channel error fix...';
            
            try {
                // 1. Clear any existing message listeners
                if (window.removeEventListener) {
                    // Remove potential problematic listeners
                    window.removeEventListener('message', null);
                    window.removeEventListener('storage', null);
                }

                // 2. Set up proper error boundaries
                window.addEventListener('error', function(event) {
                    if (event.error && event.error.message && event.error.message.includes('message channel closed')) {
                        log('Message channel error intercepted and prevented', 'success');
                        event.preventDefault();
                        event.stopPropagation();
                        return false;
                    }
                }, true);

                // 3. Handle unhandled promise rejections
                window.addEventListener('unhandledrejection', function(event) {
                    if (event.reason && event.reason.message && event.reason.message.includes('message channel closed')) {
                        log('Unhandled message channel rejection intercepted', 'success');
                        event.preventDefault();
                        return false;
                    }
                });

                // 4. Set up proper async operation management
                window.asyncOperationManager = {
                    operations: new Map(),
                    addOperation: function(id, operation) {
                        this.operations.set(id, operation);
                        return id;
                    },
                    removeOperation: function(id) {
                        this.operations.delete(id);
                    },
                    cleanup: function() {
                        this.operations.clear();
                    }
                };

                // 5. Override console methods to catch errors
                const originalConsoleError = console.error;
                console.error = function(...args) {
                    const message = args.join(' ');
                    if (message.includes('message channel closed')) {
                        log('Message channel error logged to console - handled', 'warning');
                        return;
                    }
                    originalConsoleError.apply(console, args);
                };

                statusDiv.innerHTML = `
                    <div class="status status-success">‚úÖ Message channel error fix applied successfully!</div>
                    <div>Applied fixes:</div>
                    <ul>
                        <li>‚úÖ Error event listeners</li>
                        <li>‚úÖ Promise rejection handlers</li>
                        <li>‚úÖ Async operation manager</li>
                        <li>‚úÖ Console error override</li>
                    </ul>
                `;
                
                log('Message channel error fix applied successfully', 'success');
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status status-error">‚ùå Error applying fix: ${error.message}</div>`;
                log(`Error applying message channel fix: ${error.message}`, 'error');
            }
        }

        // Check error status
        function checkErrorStatus() {
            const statusDiv = document.getElementById('error-fix-status');
            statusDiv.innerHTML = 'Checking error status...';
            
            try {
                let status = '<h4>Error Handling Status:</h4>';
                
                // Check if error handlers are set up
                const hasErrorHandler = window.onerror !== null;
                const hasUnhandledRejectionHandler = window.onunhandledrejection !== null;
                const hasAsyncManager = !!window.asyncOperationManager;
                
                status += `<div>${hasErrorHandler ? '‚úÖ' : '‚ùå'} Global error handler: ${hasErrorHandler ? 'Active' : 'Not set'}</div>`;
                status += `<div>${hasUnhandledRejectionHandler ? '‚úÖ' : '‚ùå'} Promise rejection handler: ${hasUnhandledRejectionHandler ? 'Active' : 'Not set'}</div>`;
                status += `<div>${hasAsyncManager ? '‚úÖ' : '‚ùå'} Async operation manager: ${hasAsyncManager ? 'Active' : 'Not set'}</div>`;
                
                // Check for any existing message channel errors
                const hasMessageChannelErrors = window.messageChannelErrors || 0;
                status += `<div>üìä Message channel errors caught: ${hasMessageChannelErrors}</div>`;
                
                statusDiv.innerHTML = status;
                log('Error status checked');
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status status-error">‚ùå Error checking status: ${error.message}</div>`;
                log(`Error checking error status: ${error.message}`, 'error');
            }
        }

        // Debug functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('error-log');
            const statusClass = type === 'error' ? 'status-error' : type === 'warning' ? 'status-warning' : 'status-success';
            
            logDiv.innerHTML += `<div class="status ${statusClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function checkDataStatus() {
            const statusDiv = document.getElementById('data-status');
            statusDiv.innerHTML = 'Checking data status...';
            
            try {
                // Check localStorage
                const localStorageData = {
                    inventory: localStorage.getItem('inventory'),
                    vendors: localStorage.getItem('vendors'),
                    customers: localStorage.getItem('customers'),
                    repairs: localStorage.getItem('repairs'),
                    invoices: localStorage.getItem('invoices'),
                    quotations: localStorage.getItem('quotations'),
                    purchases: localStorage.getItem('purchases'),
                    outsource: localStorage.getItem('outsource'),
                    pickDrops: localStorage.getItem('pickDrops'),
                    payments: localStorage.getItem('payments'),
                    deliveries: localStorage.getItem('deliveries'),
                    users: localStorage.getItem('users')
                };

                let status = '<h4>LocalStorage Status:</h4>';
                Object.entries(localStorageData).forEach(([key, value]) => {
                    if (value) {
                        try {
                            const parsed = JSON.parse(value);
                            status += `<div>‚úÖ ${key}: ${parsed.length} items</div>`;
                        } catch (e) {
                            status += `<div>‚ùå ${key}: Invalid JSON</div>`;
                        }
                    } else {
                        status += `<div>‚ùå ${key}: Not found</div>`;
                    }
                });

                // Check global variables
                status += '<h4>Global Variables Status:</h4>';
                if (typeof inventory !== 'undefined') {
                    status += `<div>‚úÖ inventory: ${inventory ? inventory.length : 'undefined'} items</div>`;
                } else {
                    status += `<div>‚ùå inventory: Not defined</div>`;
                }

                if (typeof customers !== 'undefined') {
                    status += `<div>‚úÖ customers: ${customers ? customers.length : 'undefined'} items</div>`;
                } else {
                    status += `<div>‚ùå customers: Not defined</div>`;
                }

                if (typeof users !== 'undefined') {
                    status += `<div>‚úÖ users: ${users ? users.length : 'undefined'} items</div>`;
                } else {
                    status += `<div>‚ùå users: Not defined</div>`;
                }

                statusDiv.innerHTML = status;
                log('Data status checked successfully');
            } catch (error) {
                statusDiv.innerHTML = `Error checking data status: ${error.message}`;
                log(`Error checking data status: ${error.message}`, 'error');
            }
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone!')) {
                try {
                    localStorage.clear();
                    log('All localStorage data cleared');
                    
                    // Reset global variables
                    if (typeof clearLocalStorageData === 'function') {
                        clearLocalStorageData();
                    }
                    
                    checkDataStatus();
                    log('All data cleared successfully');
                } catch (error) {
                    log(`Error clearing data: ${error.message}`, 'error');
                }
            }
        }

        function loadDefaultData() {
            try {
                if (typeof loadData === 'function') {
                    loadData();
                    log('Default data loaded');
                    setTimeout(checkDataStatus, 1000);
                } else {
                    log('loadData function not available', 'error');
                }
            } catch (error) {
                log(`Error loading default data: ${error.message}`, 'error');
            }
        }

        function checkAuthStatus() {
            const authDiv = document.getElementById('auth-status');
            authDiv.innerHTML = 'Checking authentication status...';
            
            try {
                let status = '<h4>Authentication Status:</h4>';
                
                if (typeof currentUser !== 'undefined' && currentUser) {
                    status += `<div>‚úÖ Logged in as: ${currentUser.username}</div>`;
                    status += `<div>Role: ${currentUser.role}</div>`;
                    status += `<div>Permissions: ${currentUser.permissions ? currentUser.permissions.join(', ') : 'None'}</div>`;
                } else {
                    status += `<div>‚ùå Not logged in</div>`;
                }

                if (typeof window.auth !== 'undefined' && window.auth) {
                    status += `<div>‚úÖ Firebase Auth available</div>`;
                    if (window.auth.currentUser) {
                        status += `<div>Firebase User: ${window.auth.currentUser.uid}</div>`;
                    } else {
                        status += `<div>No Firebase user</div>`;
                    }
                } else {
                    status += `<div>‚ùå Firebase Auth not available</div>`;
                }

                authDiv.innerHTML = status;
                log('Authentication status checked');
            } catch (error) {
                authDiv.innerHTML = `Error checking auth status: ${error.message}`;
                log(`Error checking auth status: ${error.message}`, 'error');
            }
        }

        function testLogin() {
            try {
                if (typeof authenticateUser === 'function') {
                    const result = authenticateUser('admin', 'admin');
                    if (result) {
                        log('Login successful');
                        checkAuthStatus();
                    } else {
                        log('Login failed', 'error');
                    }
                } else {
                    log('authenticateUser function not available', 'error');
                }
            } catch (error) {
                log(`Error during login: ${error.message}`, 'error');
            }
        }

        function logout() {
            try {
                if (typeof logout === 'function') {
                    logout();
                    log('Logged out');
                    checkAuthStatus();
                } else {
                    log('logout function not available', 'error');
                }
            } catch (error) {
                log(`Error during logout: ${error.message}`, 'error');
            }
        }

        function checkCloudSync() {
            const cloudDiv = document.getElementById('cloud-status');
            cloudDiv.innerHTML = 'Checking cloud sync status...';
            
            try {
                let status = '<h4>Cloud Sync Status:</h4>';
                
                if (typeof checkSyncStatus === 'function') {
                    checkSyncStatus();
                    status += '<div>‚úÖ Sync status checked (see console for details)</div>';
                } else {
                    status += '<div>‚ùå checkSyncStatus function not available</div>';
                }

                if (typeof window.db !== 'undefined') {
                    status += '<div>‚úÖ Firebase database available</div>';
                } else {
                    status += '<div>‚ùå Firebase database not available</div>';
                }

                cloudDiv.innerHTML = status;
                log('Cloud sync status checked');
            } catch (error) {
                cloudDiv.innerHTML = `Error checking cloud sync: ${error.message}`;
                log(`Error checking cloud sync: ${error.message}`, 'error');
            }
        }

        function forceSyncToCloud() {
            try {
                if (typeof forceSyncToCloud === 'function') {
                    forceSyncToCloud();
                    log('Force sync to cloud initiated');
                } else {
                    log('forceSyncToCloud function not available', 'error');
                }
            } catch (error) {
                log(`Error during force sync: ${error.message}`, 'error');
            }
        }

        function testCloudConnection() {
            try {
                if (typeof testFirebaseConnection === 'function') {
                    testFirebaseConnection();
                    log('Firebase connection test initiated');
                } else {
                    log('testFirebaseConnection function not available', 'error');
                }
            } catch (error) {
                log(`Error testing cloud connection: ${error.message}`, 'error');
            }
        }

        function showCustomers() {
            const customersDiv = document.getElementById('customers-display');
            customersDiv.innerHTML = 'Loading customers...';
            
            try {
                if (typeof customers !== 'undefined' && customers) {
                    let html = `<h4>Customers (${customers.length}):</h4>`;
                    customers.forEach((customer, index) => {
                        html += `<div><strong>${index + 1}.</strong> ${customer.name} - ${customer.phone} - ${customer.status}</div>`;
                    });
                    customersDiv.innerHTML = html;
                    log(`Displayed ${customers.length} customers`);
                } else {
                    customersDiv.innerHTML = '<div>‚ùå No customers data available</div>';
                    log('No customers data available', 'warning');
                }
            } catch (error) {
                customersDiv.innerHTML = `Error displaying customers: ${error.message}`;
                log(`Error displaying customers: ${error.message}`, 'error');
            }
        }

        function addTestCustomer() {
            try {
                if (typeof customers !== 'undefined') {
                    const testCustomer = {
                        id: Date.now(),
                        name: `Test Customer ${Date.now()}`,
                        phone: '+91-99999-99999',
                        email: `test${Date.now()}@example.com`,
                        address: 'Test Address',
                        preferredDevice: 'laptop',
                        status: 'active',
                        notes: 'Test customer added via debug console',
                        totalRepairs: 0,
                        lastVisit: new Date().toISOString().split('T')[0]
                    };
                    
                    customers.push(testCustomer);
                    
                    if (typeof saveData === 'function') {
                        saveData();
                        log('Test customer added and saved');
                        showCustomers();
                    } else {
                        log('Test customer added but saveData function not available', 'warning');
                    }
                } else {
                    log('customers array not available', 'error');
                }
            } catch (error) {
                log(`Error adding test customer: ${error.message}`, 'error');
            }
        }

        function clearCustomers() {
            if (confirm('Are you sure you want to clear all customers?')) {
                try {
                    if (typeof customers !== 'undefined') {
                        customers.length = 0;
                        
                        if (typeof saveData === 'function') {
                            saveData();
                            log('All customers cleared');
                            showCustomers();
                        } else {
                            log('Customers cleared but saveData function not available', 'warning');
                        }
                    } else {
                        log('customers array not available', 'error');
                    }
                } catch (error) {
                    log(`Error clearing customers: ${error.message}`, 'error');
                }
            }
        }

        function showAvailableFunctions() {
            const functionsDiv = document.getElementById('functions-display');
            functionsDiv.innerHTML = 'Checking available functions...';
            
            try {
                let html = '<h4>Available Functions:</h4>';
                const functions = [
                    'loadData', 'saveData', 'renderCustomers', 'renderInventory',
                    'authenticateUser', 'checkLoginStatus', 'showSection',
                    'handleAddCustomer', 'handleAddItem', 'updateDashboard'
                ];
                
                functions.forEach(funcName => {
                    if (typeof window[funcName] === 'function') {
                        html += `<div>‚úÖ ${funcName}</div>`;
                    } else {
                        html += `<div>‚ùå ${funcName}</div>`;
                    }
                });
                
                functionsDiv.innerHTML = html;
                log('Available functions checked');
            } catch (error) {
                functionsDiv.innerHTML = `Error checking functions: ${error.message}`;
                log(`Error checking functions: ${error.message}`, 'error');
            }
        }

        function testNavigation() {
            try {
                if (typeof testNavigation === 'function') {
                    testNavigation('customers');
                    log('Navigation test initiated');
                } else {
                    log('testNavigation function not available', 'error');
                }
            } catch (error) {
                log(`Error testing navigation: ${error.message}`, 'error');
            }
        }

        function checkAppState() {
            try {
                if (typeof debugAppState === 'function') {
                    debugAppState();
                    log('App state debug initiated');
                } else {
                    log('debugAppState function not available', 'error');
                }
            } catch (error) {
                log(`Error checking app state: ${error.message}`, 'error');
            }
        }

        function clearErrorLog() {
            document.getElementById('error-log').innerHTML = '';
            log('Error log cleared');
        }

        function applyMessageChannelFix() {
            try {
                if (window.messageChannelFix && typeof window.messageChannelFix.initialize === 'function') {
                    window.messageChannelFix.initialize();
                    log('Message channel fix applied successfully', 'success');
                } else {
                    log('Message channel fix not available - script may not be loaded', 'error');
                }
            } catch (error) {
                log(`Error applying message channel fix: ${error.message}`, 'error');
            }
        }

        // Initialize debug console
        window.addEventListener('load', function() {
            log('Debug console initialized');
            
            // Apply message channel error fix automatically
            setTimeout(() => {
                fixMessageChannelError();
            }, 1000);
            
            checkDataStatus();
            checkAuthStatus();
        });

        // Override console.log to also show in our debug log
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            log(args.join(' '), 'info');
        };

        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            log(args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            log(args.join(' '), 'warning');
        };
    </script>
</body>
</html>



