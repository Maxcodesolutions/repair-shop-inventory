<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Debug - Repair Shop Inventory</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .debug-button:hover {
            background: #0056b3;
        }
        .debug-button.danger {
            background: #dc3545;
        }
        .debug-button.danger:hover {
            background: #c82333;
        }
        .debug-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-success {
            color: #28a745;
            font-weight: bold;
        }
        .status-error {
            color: #dc3545;
            font-weight: bold;
        }
        .status-warning {
            color: #ffc107;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ Login Debug Tool</h1>
    <p>Use this page to debug login issues with your repair shop inventory system.</p>

    <div class="debug-section">
        <h2>ðŸ“Š Current Status</h2>
        <button class="debug-button" onclick="checkCurrentStatus()">Check Current Status</button>
        <button class="debug-button" onclick="showLocalStorage()">Show LocalStorage</button>
        <button class="debug-button" onclick="showUsers()">Show Users</button>
        <div id="status-output" class="debug-output"></div>
    </div>

    <div class="debug-section">
        <h2>ðŸ”§ Debug Actions</h2>
        <button class="debug-button" onclick="resetLoginData()">Reset Login Data</button>
        <button class="debug-button" onclick="ensureAdminUser()">Ensure Admin User</button>
        <button class="debug-button danger" onclick="clearAllData()">Clear All Data</button>
        <div id="debug-output" class="debug-output"></div>
    </div>

    <div class="debug-section">
        <h2>ðŸ§ª Test Login</h2>
        <form id="test-login-form">
            <label for="test-username">Username:</label>
            <input type="text" id="test-username" value="admin" style="margin: 10px;">
            <br>
            <label for="test-password">Password:</label>
            <input type="password" id="test-password" value="admin" style="margin: 10px;">
            <br>
            <button type="submit" class="debug-button">Test Login</button>
        </form>
        <div id="test-output" class="debug-output"></div>
    </div>

    <div class="debug-section">
        <h2>ðŸš€ Quick Fix</h2>
        <p>If you're having login issues, try this:</p>
        <button class="debug-button" onclick="quickFix()">Apply Quick Fix</button>
        <div id="quick-fix-output" class="debug-output"></div>
    </div>

    <div class="debug-section">
        <h2>ðŸ“± Go to Main App</h2>
        <a href="index.html" class="debug-button" style="text-decoration: none; display: inline-block;">Open Main Application</a>
    </div>

    <script>
        // Load the main script to access its functions
        let users = [];
        let currentUser = null;
        let currentUserId = null;

        function loadData() {
            try {
                const usersData = localStorage.getItem('users');
                if (usersData) {
                    users = JSON.parse(usersData);
                } else {
                    users = getDefaultUsers();
                }
            } catch (error) {
                console.error('Error loading users:', error);
                users = getDefaultUsers();
            }
        }

        function getDefaultUsers() {
            return [
                {
                    id: 1,
                    username: 'admin',
                    password: 'admin',
                    fullName: 'System Administrator',
                    email: 'admin@repairmaniac.com',
                    role: 'admin',
                    status: 'active',
                    permissions: ['dashboard', 'inventory', 'purchases', 'vendors', 'customers', 'repairs', 'outsource', 'invoices', 'quotations', 'pickdrop', 'delivery', 'payments', 'reports', 'users'],
                    lastLogin: null,
                    createdAt: new Date().toISOString()
                }
            ];
        }

        function saveData() {
            localStorage.setItem('users', JSON.stringify(users));
        }

        function authenticateUser(username, password) {
            console.log('Attempting to authenticate user:', username);
            console.log('Available users:', users);
            
            const user = users.find(u => u.username === username && u.password === password && u.status === 'active');
            if (user) {
                console.log('User authenticated successfully:', user);
                currentUser = user;
                user.lastLogin = new Date().toISOString();
                saveData();
                return user;
            } else {
                console.log('Authentication failed. User not found or invalid credentials.');
                console.log('Looking for user with username:', username);
                console.log('Users in system:', users.map(u => ({ username: u.username, status: u.status })));
            }
            return null;
        }

        function ensureAdminUser() {
            console.log('Ensuring admin user exists...');
            console.log('Current users:', users);
            
            const adminUser = users.find(u => u.username === 'admin');
            
            if (!adminUser) {
                console.log('Admin user not found, creating...');
                const newAdminUser = {
                    id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1,
                    username: 'admin',
                    password: 'admin',
                    fullName: 'System Administrator',
                    email: 'admin@repairmaniac.com',
                    role: 'admin',
                    status: 'active',
                    permissions: ['dashboard', 'inventory', 'purchases', 'vendors', 'customers', 'repairs', 'outsource', 'invoices', 'quotations', 'pickdrop', 'delivery', 'payments', 'reports', 'users'],
                    lastLogin: null,
                    createdAt: new Date().toISOString()
                };
                
                users.push(newAdminUser);
                saveData();
                console.log('Admin user created:', newAdminUser);
                return 'Admin user created successfully!';
            } else {
                console.log('Admin user already exists:', adminUser);
                return 'Admin user already exists!';
            }
        }

        function resetLoginData() {
            console.log('Resetting login data...');
            localStorage.removeItem('loginStatus');
            localStorage.removeItem('currentUserId');
            currentUser = null;
            currentUserId = null;
            
            loadData();
            ensureAdminUser();
            
            console.log('Login data reset. Admin user should be available.');
            console.log('Available users after reset:', users);
            return 'Login data reset successfully!';
        }

        function checkCurrentStatus() {
            loadData();
            const loginStatus = localStorage.getItem('loginStatus');
            const currentUserId = localStorage.getItem('currentUserId');
            
            let output = '=== CURRENT STATUS ===\n';
            output += `Login Status: ${loginStatus}\n`;
            output += `Current User ID: ${currentUserId}\n`;
            output += `Users Count: ${users.length}\n`;
            output += `Admin User Exists: ${users.find(u => u.username === 'admin') ? 'YES' : 'NO'}\n`;
            
            if (users.find(u => u.username === 'admin')) {
                const admin = users.find(u => u.username === 'admin');
                output += `Admin Status: ${admin.status}\n`;
                output += `Admin Password: ${admin.password}\n`;
            }
            
            return output;
        }

        function showLocalStorage() {
            let output = '=== LOCALSTORAGE CONTENTS ===\n';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                output += `${key}: ${value}\n`;
            }
            return output;
        }

        function showUsers() {
            loadData();
            let output = '=== USERS DATA ===\n';
            users.forEach((user, index) => {
                output += `User ${index + 1}:\n`;
                output += `  ID: ${user.id}\n`;
                output += `  Username: ${user.username}\n`;
                output += `  Password: ${user.password}\n`;
                output += `  Status: ${user.status}\n`;
                output += `  Role: ${user.role}\n`;
                output += `  Permissions: ${user.permissions.join(', ')}\n`;
                output += `  Last Login: ${user.lastLogin || 'Never'}\n`;
                output += '\n';
            });
            return output;
        }

        function clearAllData() {
            localStorage.clear();
            users = [];
            currentUser = null;
            currentUserId = null;
            return 'All data cleared! Please refresh the page.';
        }

        function quickFix() {
            let output = '=== APPLYING QUICK FIX ===\n';
            
            // Clear login data
            localStorage.removeItem('loginStatus');
            localStorage.removeItem('currentUserId');
            output += 'âœ“ Cleared login data\n';
            
            // Ensure admin user exists
            loadData();
            const result = ensureAdminUser();
            output += `âœ“ ${result}\n`;
            
            // Test authentication
            const testResult = authenticateUser('admin', 'admin');
            if (testResult) {
                output += 'âœ“ Admin authentication test PASSED\n';
            } else {
                output += 'âœ— Admin authentication test FAILED\n';
            }
            
            return output;
        }

        // Event handlers
        function checkCurrentStatus() {
            document.getElementById('status-output').textContent = checkCurrentStatus();
        }

        function showLocalStorage() {
            document.getElementById('status-output').textContent = showLocalStorage();
        }

        function showUsers() {
            document.getElementById('status-output').textContent = showUsers();
        }

        function resetLoginData() {
            document.getElementById('debug-output').textContent = resetLoginData();
        }

        function ensureAdminUser() {
            document.getElementById('debug-output').textContent = ensureAdminUser();
        }

        function clearAllData() {
            document.getElementById('debug-output').textContent = clearAllData();
        }

        function quickFix() {
            document.getElementById('quick-fix-output').textContent = quickFix();
        }

        // Test login form
        document.getElementById('test-login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('test-username').value;
            const password = document.getElementById('test-password').value;
            
            loadData();
            const result = authenticateUser(username, password);
            
            let output = '=== LOGIN TEST ===\n';
            output += `Username: ${username}\n`;
            output += `Password: ${password}\n`;
            output += `Result: ${result ? 'SUCCESS' : 'FAILED'}\n`;
            
            if (result) {
                output += `User: ${result.fullName}\n`;
                output += `Role: ${result.role}\n`;
                output += `Status: ${result.status}\n`;
            }
            
            document.getElementById('test-output').textContent = output;
        });

        // Initialize
        loadData();
    </script>
</body>
</html>
